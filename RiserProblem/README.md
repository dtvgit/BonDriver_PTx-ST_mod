# ● システム復帰時ライザー経由PT2認識不良の自動修復

システムサスペンド状態から復帰したライザー経由で設置したPT2デバイスを開こうとするとエラーを表示することがある。

![0](Images/0.png)

BIOS側がライザーを事前に把握していない環境では、PCIブリッジのライザー下の初期化に時間がかかるデバイスをすっ飛ばすことで起こる可能性の高い事案であると予測できる。
なので、システム復帰時にそのすっ飛ばされたデバイス(PT2)を再認識させて改修することについてまとめてみることにしてみた。

まず、デバイスマネージャを開く。
左下のルーペマークをクリックして検索欄に"デバイス"と入力して"開く"を選択。

![デバマネ表示](Images/DevMngr.png)

"サウンド、デバイス、およびゲームコントローラー" 欄に "EARTH SOFT PT2" が居る事を確認。

![1](Images/1.png)

"EARTH SOFT PT2" を選択して右クリックしてスピードメニューから "プロパティ" を選択。

![2](Images/2.png)

プロパティ画面が開いたら、上のタブから "詳細" を選択し、プロパティ欄から "デバイスインスタンスパス" を選択し、表示された値欄を右クリックしてスピードメニューから "コピー" を選択。

![3](Images/3.png)

Cドライブのルートに "ResetRiser" フォルダを作成し、そのフォルダーの中に "ResetPT2.bat" を作成する。

![バッチ作成](Images/ResetBat.png)

ResetPT2.bat の中身は下記の様に記述する。
```
pnputil /restart-device "<先程コピーした EARTH SOFT PT2 のデバイスインスパスをココへペースト>"
```
上記は、応答不能になったデバイスを再始動するコマンド。
これをシステム復帰時毎に起動することを目的にタスクマネージャに登録する。

タスクマネージャを開く。
左下のルーペマークをクリックして検索欄に"PC"と入力して"管理"を選択。

![PCの管理表示](Images/AdminPC.png)

システムツール > タスクスケジューラ > タスクスケジューラライブラリ を選択。
右側のメニュー欄から "タスクの作成" をクリック

![4-1](Images/4-1.png)

タスクの作成が表示されたら"全般" 欄が表示されるていると思うので、下記のように編集する。
- 名前: "PT2のリセット"
- 説明: 適当(PT2スタンバイ復帰処理等)
- **最上位の特権で実行する**にチェック

![5-1](Images/5-1.png)

次に、"トリガー" 欄を上のタブから選択し、"新規" をクリック。

![6-1](Images/6-1.png)

新しいトリガーが表示されたら、下記のように編集して、"OK" ボタンをクリックして画面を閉じる。
- タスクの開始: イベント時
- ログ: システム
- ソース: Power-TroubleShooter
- イベントID: 1
- **遅延時間を指定する**をチェックして 20 秒間 にセット

![7](Images/7.png)

すると、サスペンドからのシステム復帰時20秒後に発動するトリガーがこのように登録される。

![8](Images/8.png)

次に、"操作" 欄を上のタブから選択し、"新規" をクリック。

![9-1](Images/9-1.png)

新しい操作が表示されたら、"プログラム／スクリプト" 欄に先程作成したバッチファイルのパス "C:\ResetRiser\ResetPT2.bat" を書いて、"OK" ボタンをクリックして画面を閉じる。

![A](Images/A.png)

すると、トリガー時(サスペンドからの復帰時)に自動的に開始されるプログラムとして "C:\ResetRiser\ResetPT2.bat" がこのように登録される。

![B](Images/B.png)

"OKボタン" を押すとこのように "PT2のリセット" がタスクとして登録され、システム復帰時毎にPT2デバイスの再始動が以後、自動的に行われるようになる。

![C](Images/C.png)

筆者の環境では、ASM1083チップを搭載したライザーカード経由でPT2を動作させているのですが、このタスクを登録してからは、システム復帰時にPT2デバイスを見失うことはなくなりました。

*※ pnputil /restart-device コマンドは、Windows10 2004 以降の環境が必要なことに注意。*

以上ノシ
